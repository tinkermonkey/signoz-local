# Fluent Bit Configuration for SigNoz Log Collection
# Collects logs from Docker containers by executing docker logs command

[SERVICE]
    Flush        5
    Daemon       Off
    Log_Level    info
    Parsers_File parsers.conf

# Read Python app logs using docker logs
[INPUT]
    Name              exec
    Tag               python-app
    Command           docker logs -f test-python-app 2>&1
    Parser            json_log
    Interval_Sec      1

# Read TypeScript app logs using docker logs
[INPUT]
    Name              exec
    Tag               typescript-app
    Command           docker logs -f test-typescript-app 2>&1
    Parser            json_log
    Interval_Sec      1

# Parse Docker JSON logs
[FILTER]
    Name    parser
    Match   docker.*
    Key_Name log
    Parser  json_log
    Reserve_Data On
    Preserve_Key On

# Add deployment environment metadata
[FILTER]
    Name    modify
    Match   docker.*
    Add     deployment.environment test-platform

# Extract Docker container metadata (name, id, labels)
[FILTER]
    Name    nest
    Match   docker.*
    Operation lift
    Nested_under attrs
    Add_prefix attrs_

# Rename fields to match OpenTelemetry conventions
[FILTER]
    Name    modify
    Match   docker.*
    Rename  attrs_container.name container.name
    Rename  attrs_container.id container.id

# Send logs to SigNoz via OTLP HTTP
[OUTPUT]
    Name   opentelemetry
    Match  docker.*
    Host   ${SIGNOZ_HOST}
    Port   ${SIGNOZ_PORT}
    Logs_uri /v1/logs
    Log_response_payload True
    Tls    Off
    
# Debug output (optional - comment out in production)
[OUTPUT]
    Name   stdout
    Match  docker.*
    Format json_lines
